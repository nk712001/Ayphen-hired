'use client';

import React, { useState, useEffect } from 'react';
import { AlertTriangle, ExternalLink, Globe } from 'lucide-react';
import { QRCodeSVG } from 'qrcode.react';

interface SecureQRCodeInstructionsProps {
  qrCodeUrl: string;
  mobileUrl?: string;
  isChecking?: boolean;
  isConnected?: boolean;
}

export const SecureQRCodeInstructions: React.FC<SecureQRCodeInstructionsProps> = ({ qrCodeUrl, mobileUrl = qrCodeUrl, isChecking = false, isConnected = false }) => {
  // Log the received URLs for debugging
  console.log('SecureQRCodeInstructions received:', { qrCodeUrl, mobileUrl });
  
  // Validate URL format
  const isValidUrl = (url: string) => {
    try {
      new URL(url);
      return true;
    } catch (e) {
      console.error('Invalid URL format:', url, e);
      return false;
    }
  };
  
  // Check if URLs are valid and log errors
  const qrCodeUrlValid = isValidUrl(qrCodeUrl);
  const mobileUrlValid = isValidUrl(mobileUrl);
  
  if (!qrCodeUrlValid || !mobileUrlValid) {
    console.error('Invalid URL detected:', { 
      qrCodeUrl, 
      qrCodeUrlValid, 
      mobileUrl, 
      mobileUrlValid 
    });
  }
  
  // Check if we're in development mode - safe for server-side rendering
  const isDevelopment = process.env.NODE_ENV === 'development';

  // State for secure context and protocol detection
  const [isSecureContext, setIsSecureContext] = useState(true); // Default to secure
  const [isLocalhost, setIsLocalhost] = useState(false);
  const [isHttpProtocol, setIsHttpProtocol] = useState(false);
  const [isSecure, setIsSecure] = useState(true); // Default to secure until client-side check
  
  // State for device detection
  const [isMobileDevice, setIsMobileDevice] = useState(false);
  const [isIOSDevice, setIsIOSDevice] = useState(false);
  
  // Check security context in useEffect to avoid window not defined error
  useEffect(() => {
    // Now we're safely on the client side
    const secureContext = window.isSecureContext || window.location.protocol === 'https:';
    const localhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const httpProtocol = window.location.protocol === 'http:';
    
    // Detect mobile and iOS devices
    const mobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const iOSDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as any).MSStream;
    
    setIsMobileDevice(mobileDevice);
    setIsIOSDevice(iOSDevice);
    setIsSecureContext(secureContext);
    setIsLocalhost(localhost);
    setIsHttpProtocol(httpProtocol);
    
    // In development mode, we'll consider any connection secure
    setIsSecure(isDevelopment || secureContext || localhost);
    
    // Log device information for debugging
    console.log('Device detection:', {
      isMobile: mobileDevice,
      isIOS: iOSDevice,
      userAgent: navigator.userAgent,
      secureContext,
      localhost,
      httpProtocol,
      isDevelopment
    });
  }, [isDevelopment]);

  return (
    <div className="bg-white p-6 rounded-xl border border-primary-200 flex flex-col items-center max-w-md">
      <h3 className="font-medium text-primary-900 mb-3">Scan QR Code with Your Phone</h3>
      
      {!isSecure && !isDevelopment && (
        <div className="bg-primary-50 border border-primary-200 text-primary-700 p-3 rounded-lg mb-4 flex items-start w-full">
          <AlertTriangle className="h-5 w-5 text-primary-600 mt-0.5 mr-2 flex-shrink-0" />
          <div>
            <p className="font-medium">HTTPS Required</p>
            <p className="text-sm mt-1">
              Camera access requires a secure connection (HTTPS). You are currently on HTTP.
            </p>
            <div className="mt-2 text-sm">
              <p className="font-medium">Options:</p>
              <ul className="list-disc pl-5 mt-1 space-y-1">
                <li>Use the direct link on your mobile device (tap button below)</li>
                <li>Deploy this app with HTTPS enabled</li>
                <li>Use a local HTTPS development server</li>
              </ul>
            </div>
          </div>
        </div>
      )}
      
      {isDevelopment && isHttpProtocol && (
        <div className="bg-primary-50 border border-primary-200 text-primary-700 p-3 rounded-lg mb-4 flex items-start w-full">
          <Globe className="h-5 w-5 text-primary-600 mt-0.5 mr-2 flex-shrink-0" />
          <div>
            <p className="font-medium">Development Mode</p>
            <p className="text-sm mt-1">
              Running in development mode with HTTP. Camera access should work, but some browsers might still require HTTPS.
            </p>
          </div>
        </div>
      )}
      
      <p className="text-primary-800 text-sm text-center mb-4">
        {isSecure || isDevelopment
          ? "Scan this QR code with your mobile phone to use it as a secondary camera."
          : "Due to security restrictions, you may need to open the link directly on your mobile device:"}
      </p>
      
      {isMobileDevice && (
        <div className="bg-primary-50 border border-primary-200 text-primary-700 p-3 rounded-lg mb-4 w-full text-left">
          <p className="font-medium">You're on a mobile device</p>
          <p className="text-sm mt-1">
            It looks like you're already on a mobile device. You can:
          </p>
          <ul className="list-disc pl-5 mt-1 text-sm space-y-1">
            <li>Open the link directly by tapping the button below</li>
            <li>Use this device as your secondary camera</li>
          </ul>
        </div>
      )}
      
      {isIOSDevice && (
        <div className="bg-primary-50 border border-primary-200 text-primary-700 p-3 rounded-lg mb-4 w-full text-left">
          <p className="font-medium">iOS Device Detected</p>
          <p className="text-sm mt-1">
            For iOS devices, make sure to:
          </p>
          <ul className="list-disc pl-5 mt-1 text-sm space-y-1">
            <li>Use Safari browser for best camera compatibility</li>
            <li>Grant camera permissions when prompted</li>
            <li>Keep the page open during the entire session</li>
          </ul>
        </div>
      )}
      
      <div className="bg-white p-3 rounded-lg shadow-md mb-4 relative">
        {/* Connection status overlay */}
        {isChecking && (
          <div className="absolute inset-0 bg-black/50 z-10 flex items-center justify-center rounded-lg">
            <div className="text-center text-white p-4">
              <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-white mx-auto mb-3"></div>
              <p className="font-medium">Connecting...</p>
              <p className="text-sm mt-1">Waiting for mobile device</p>
            </div>
          </div>
        )}
        
        {isConnected && (
          <div className="absolute inset-0 bg-green-500/80 z-10 flex items-center justify-center rounded-lg">
            <div className="text-center text-white p-4">
              <div className="rounded-full h-16 w-16 bg-white/20 flex items-center justify-center mx-auto mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <p className="font-medium text-lg">Connected!</p>
              <p className="text-sm mt-1">Mobile camera is ready</p>
            </div>
          </div>
        )}
        
        {/* QR Code */}
        {qrCodeUrl && qrCodeUrlValid ? (
          <>
            <QRCodeSVG 
              value={qrCodeUrl} 
              size={192} 
              bgColor="#FFFFFF"
              fgColor="#000000"
              level="M"
              includeMargin={true}
              className="w-48 h-48"
              // Add error handling with proper type annotation
              onError={(error: Error) => {
                console.error('QR Code generation error:', error);
              }}
            />
          </>
        ) : qrCodeUrl && !qrCodeUrlValid ? (
          <div className="w-48 h-48 flex items-center justify-center border border-gray-300 rounded bg-red-50">
            <div className="text-center p-2">
              <AlertTriangle className="h-8 w-8 text-red-500 mx-auto mb-2" />
              <p className="text-red-700 font-medium">Invalid URL</p>
              <p className="text-red-600 text-xs mt-1">The QR code URL is invalid</p>
            </div>
          </div>
        ) : (
          <div className="w-48 h-48 flex items-center justify-center border border-gray-300 rounded">
            <div className="text-center">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"></div>
              <p className="text-gray-500">QR Code<br />Loading...</p>
            </div>
          </div>
        )}
      </div>
      
      {/* Always show the direct link button for easier access */}
      {mobileUrlValid ? (
        <a 
          href={mobileUrl}
          target="_blank"
          rel="noopener noreferrer"
          className="flex items-center justify-center bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded-md transition-colors mb-4 w-full"
          onClick={() => console.log('Opening mobile URL:', mobileUrl)}
        >
          Open Camera Link <ExternalLink className="ml-2 h-4 w-4" />
        </a>
      ) : (
        <button 
          className="flex items-center justify-center bg-gray-400 text-white py-2 px-4 rounded-md mb-4 w-full cursor-not-allowed"
          disabled
          title="Invalid URL"
        >
          Invalid Camera Link <AlertTriangle className="ml-2 h-4 w-4" />
        </button>
      )}
      
      <div className="text-center text-sm text-primary-700">
        <p>After scanning or opening the link, allow camera access when prompted</p>
        
        {/* Debug info - show the actual URL */}
        {isDevelopment && (
          <div className="mt-4 p-2 bg-gray-100 rounded-md overflow-auto max-w-full">
            <p className="text-xs text-gray-500 break-all">{qrCodeUrl || 'No URL generated'}</p>
          </div>
        )}
      </div>
    </div>
  );
};

// Add default export
export default SecureQRCodeInstructions;
